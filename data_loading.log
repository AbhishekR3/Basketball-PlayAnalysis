2024-08-29 15:33:04,603 - ERROR - Error in main function: (psycopg2.errors.SyntaxError) unterminated dollar-quoted string at or near "$$
        declare 
            nth_record record;
        basketball_cursor cursor for
            -- Extract the basketball coordinate in each frame
            WITH basketball_frame AS (
                SELECT
                frame,
                point_geom,
                row_number() over(partition by frame order by age desc) as age_rownumber
                FROM tracking_data
                WHERE is_basketball = TRUE
                )
            SELECT
                frame,
                point_geom
            FROM 
                basketball_frame
            WHERE 
                age_rownumber = 1
            ORDER BY 
                frame asc;

        -- Being cursor
        begin
            open basketball_cursor;
            loop
                fetch basketball_cursor into nth_record;
                exit when not found;
                
                -- Extract top 3 closests players to the basketball
                select
                    id,
                    distance(td.point_geom, nth_record.point_geom) as dist,
                    rank() over (order by distance(td.point_geom, nth_record.point_geom)) as dist_rank
                from
                    tracking_data td 
                where
                    frame = nth_record.frame and is_basketball is false 
                order by 
                    dist_rank asc 
                limit 3

                
            end loop
            
        close basketball_cursor;
        end;
        "
LINE 5:         as $$
                   ^

[SQL: 
                -- Create cursor procedure
        create or replace procedure closest_basketball()
        language plpgsql
        as $$
        declare 
            nth_record record;
        basketball_cursor cursor for
            -- Extract the basketball coordinate in each frame
            WITH basketball_frame AS (
                SELECT
                frame,
                point_geom,
                row_number() over(partition by frame order by age desc) as age_rownumber
                FROM tracking_data
                WHERE is_basketball = TRUE
                )
            SELECT
                frame,
                point_geom
            FROM 
                basketball_frame
            WHERE 
                age_rownumber = 1
            ORDER BY 
                frame asc;

        -- Being cursor
        begin
            open basketball_cursor;
            loop
                fetch basketball_cursor into nth_record;
                exit when not found;
                
                -- Extract top 3 closests players to the basketball
                select
                    id,
                    distance(td.point_geom, nth_record.point_geom) as dist,
                    rank() over (order by distance(td.point_geom, nth_record.point_geom)) as dist_rank
                from
                    tracking_data td 
                where
                    frame = nth_record.frame and is_basketball is false 
                order by 
                    dist_rank asc 
                limit 3

                
            end loop
            
        close basketball_cursor;
        end;
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
